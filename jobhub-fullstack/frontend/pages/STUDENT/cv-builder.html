<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·∫°o CV - JobHub</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .cv-builder-container {
            min-height: 100vh;
            background: #f8f9fa;
            padding-top: 80px;
        }
        .template-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1.5rem;
            transition: transform 0.2s;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .template-card:hover {
            transform: translateY(-4px);
        }
        .template-card.selected {
            border-color: var(--primary-color);
        }
        .template-preview {
            background: #f8f9fa;
            border-radius: 8px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }
        .cv-preview {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 2rem;
            min-height: 800px;
        }
        .form-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .loading-spinner {
            display: none;
        }
        .skill-badge {
            cursor: pointer;
        }
        .skill-badge:hover {
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="sticky-top bg-white shadow-sm">
        <nav class="navbar navbar-expand-lg navbar-light">
            <div class="container">
                <a class="navbar-brand d-flex align-items-center" href="../index.html">
                    <div class="logo-icon me-2">
                        <i class="bi bi-briefcase"></i>
                    </div>
                    <span class="fw-bold">JobHub</span>
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto me-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="student-dashboard.html">Dashboard</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="job-search.html">T√¨m vi·ªác</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="cv-builder.html">CV c·ªßa t√¥i</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="my-applications.html">·ª®ng tuy·ªÉn</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="../blog.html">Blog</a>
                        </li>
                    </ul>
                    <div class="d-flex gap-2 align-items-center">
                        <a href="../shared/notifications.html" class="btn btn-outline-secondary btn-sm position-relative">
                            <i class="bi bi-bell"></i>
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">3</span>
                        </a>
                        <div class="dropdown">
                            <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-person-circle me-1"></i>ƒêang t·∫£i...
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="student-profile.html">H·ªì s∆°</a></li>
                                <li><a class="dropdown-item" href="../shared/settings.html">C√†i ƒë·∫∑t</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" onclick="handleLogout()">ƒêƒÉng xu·∫•t</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Loading Spinner -->
    <div class="text-center loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">ƒêang t·∫£i...</span>
        </div>
        <p class="mt-2">ƒêang t·∫£i tr√¨nh t·∫°o CV...</p>
    </div>

    <!-- Main Content -->
    <div class="cv-builder-container" id="cvBuilderContent" style="display: none;">
        <div class="container">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="fw-bold mb-1">T·∫°o CV m·ªõi</h1>
                            <p class="text-muted mb-0">Ch·ªçn m·∫´u v√† ƒëi·ªÅn th√¥ng tin ƒë·ªÉ t·∫°o CV chuy√™n nghi·ªáp</p>
                        </div>
                        <div>
                            <button class="btn btn-outline-secondary me-2" onclick="previewCV()">
                                <i class="bi bi-eye me-1"></i>Xem tr∆∞·ªõc
                            </button>
                            <button class="btn btn-primary" onclick="downloadCV()">
                                <i class="bi bi-download me-1"></i>T·∫£i xu·ªëng PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <!-- Template Selection -->
                <div class="col-lg-4">
                    <div class="form-section">
                        <h5 class="fw-bold mb-3">Ch·ªçn m·∫´u CV</h5>
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="template-card selected" onclick="selectTemplate(this, 'modern')">
                                    <div class="template-preview">
                                        <div class="text-center">
                                            <i class="bi bi-file-text display-4 text-primary"></i>
                                            <p class="mt-2 mb-0">Modern</p>
                                        </div>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="template" checked>
                                        <label class="form-check-label small">M·∫´u hi·ªán ƒë·∫°i</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="template-card" onclick="selectTemplate(this, 'professional')">
                                    <div class="template-preview">
                                        <div class="text-center">
                                            <i class="bi bi-briefcase display-4 text-success"></i>
                                            <p class="mt-2 mb-0">Professional</p>
                                        </div>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="template">
                                        <label class="form-check-label small">M·∫´u chuy√™n nghi·ªáp</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="template-card" onclick="selectTemplate(this, 'creative')">
                                    <div class="template-preview">
                                        <div class="text-center">
                                            <i class="bi bi-palette display-4 text-warning"></i>
                                            <p class="mt-2 mb-0">Creative</p>
                                        </div>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="template">
                                        <label class="form-check-label small">M·∫´u s√°ng t·∫°o</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="template-card" onclick="selectTemplate(this, 'minimal')">
                                    <div class="template-preview">
                                        <div class="text-center">
                                            <i class="bi bi-layout-text-sidebar display-4 text-info"></i>
                                            <p class="mt-2 mb-0">Minimal</p>
                                        </div>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="template">
                                        <label class="form-check-label small">M·∫´u t·ªëi gi·∫£n</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- CV Information Form -->
                    <div class="form-section">
                        <h5 class="fw-bold mb-3">Th√¥ng tin CV</h5>
                        <form id="cvForm">
                            <div class="mb-3">
                                <label class="form-label">Ti√™u ƒë·ªÅ CV</label>
                                <input type="text" class="form-control" id="cvTitle" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ CV">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">M·ª•c ti√™u ngh·ªÅ nghi·ªáp</label>
                                <textarea class="form-control" id="careerObjective" rows="3" placeholder="M√¥ t·∫£ m·ª•c ti√™u ngh·ªÅ nghi·ªáp c·ªßa b·∫°n..."></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">K·ªπ nƒÉng n·ªïi b·∫≠t</label>
                                <div class="d-flex flex-wrap gap-2 mb-2" id="skillsContainer">
                                    <!-- Skills will be added here dynamically -->
                                </div>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="skillInput" placeholder="Th√™m k·ªπ nƒÉng">
                                    <button class="btn btn-outline-primary" type="button" onclick="addSkill()">Th√™m</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Kinh nghi·ªám l√†m vi·ªác</label>
                                <input type="text" class="form-control" id="workExperience" placeholder="S·ªë nƒÉm kinh nghi·ªám">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">D·ª± √°n c√° nh√¢n</label>
                                <textarea class="form-control" id="personalProjects" rows="2" placeholder="M√¥ t·∫£ d·ª± √°n c√° nh√¢n..."></textarea>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="showAvatar" checked>
                                <label class="form-check-label">Hi·ªÉn th·ªã ·∫£nh ƒë·∫°i di·ªán</label>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="showContact" checked>
                                <label class="form-check-label">Hi·ªÉn th·ªã th√¥ng tin li√™n h·ªá</label>
                            </div>
                        </form>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" onclick="saveCV()">
                            <i class="bi bi-check-circle me-2"></i>L∆∞u CV
                        </button>
                        <button class="btn btn-outline-secondary" onclick="saveDraft()">
                            <i class="bi bi-file-earmark me-2"></i>L∆∞u b·∫£n nh√°p
                        </button>
                        <a href="my-cvs.html" class="btn btn-outline-primary">
                            <i class="bi bi-arrow-left me-2"></i>Quay l·∫°i
                        </a>
                    </div>
                </div>

                <!-- CV Preview -->
                <div class="col-lg-8">
                    <div class="cv-preview" id="cvPreview">
                        <!-- Preview content will be generated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white py-5 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5>JobHub</h5>
                    <p>K·∫øt n·ªëi sinh vi√™n v·ªõi nh√† tuy·ªÉn d·ª•ng h√†ng ƒë·∫ßu.</p>
                </div>
                <div class="col-md-4">
                    <h5>Li√™n k·∫øt</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" class="text-white">V·ªÅ ch√∫ng t√¥i</a></li>
                        <li><a href="#" class="text-white">ƒêi·ªÅu kho·∫£n</a></li>
                        <li><a href="#" class="text-white">Ch√≠nh s√°ch</a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5>Li√™n h·ªá</h5>
                    <p>Email: contact@jobhub.vn</p>
                    <p>ƒêi·ªán tho·∫°i: 0123 456 789</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // Ki·ªÉm tra ƒëƒÉng nh·∫≠p v√† kh·ªüi t·∫°o trang
        document.addEventListener('DOMContentLoaded', function() {
            if (!AUTH.requireAuth()) return;
            
            const user = AUTH.getUser();
            if (user) {
                document.querySelector('.dropdown-toggle').innerHTML = 
                    `<i class="bi bi-person-circle me-1"></i>${user.fullName}`;
            }
            
            // T·∫£i d·ªØ li·ªáu CV builder
            loadCVBuilderData();
        });

        async function loadCVBuilderData() {
            showLoading();
            
            try {
                const userData = AUTH.getUser();
                const userProfile = JSON.parse(localStorage.getItem(`jobhub_student_profile_${userData.id}`) || '{}');
                const userCVs = JSON.parse(localStorage.getItem(`jobhub_cvs_${userData.id}`) || '[]');
                
                // N·∫øu c√≥ CV ƒë√£ l∆∞u, t·∫£i d·ªØ li·ªáu m·ªõi nh·∫•t
                if (userCVs.length > 0) {
                    const latestCV = userCVs[userCVs.length - 1];
                    document.getElementById('cvTitle').value = latestCV.title;
                    document.getElementById('careerObjective').value = latestCV.careerObjective || '';
                    
                    // C·∫≠p nh·∫≠t skills
                    const skillsContainer = document.getElementById('skillsContainer');
                    skillsContainer.innerHTML = '';
                    if (latestCV.skills && latestCV.skills.length > 0) {
                        latestCV.skills.forEach(skill => {
                            const skillBadge = document.createElement('span');
                            skillBadge.className = 'badge bg-primary skill-badge';
                            skillBadge.innerHTML = `${skill} <i class="bi bi-x ms-1" onclick="removeSkill(this)"></i>`;
                            skillsContainer.appendChild(skillBadge);
                        });
                    }
                } else {
                    // ƒêi·ªÅn th√¥ng tin t·ª´ profile v√†o form
                    document.getElementById('cvTitle').value = `CV ${userProfile.fullName || userData.fullName || ''}`.trim();
                    
                    if (userProfile.bio) {
                        document.getElementById('careerObjective').value = userProfile.bio;
                    }
                    
                    // Th√™m skills t·ª´ profile
                    if (userProfile.skills && Array.isArray(userProfile.skills)) {
                        const skillsContainer = document.getElementById('skillsContainer');
                        userProfile.skills.forEach(skill => {
                            const skillBadge = document.createElement('span');
                            skillBadge.className = 'badge bg-primary skill-badge';
                            skillBadge.innerHTML = `${skill} <i class="bi bi-x ms-1" onclick="removeSkill(this)"></i>`;
                            skillsContainer.appendChild(skillBadge);
                        });
                    }
                }
                
                // C·∫≠p nh·∫≠t preview
                updateCVPreview();
                
                hideLoading();
                
            } catch (error) {
                console.error('L·ªói t·∫£i d·ªØ li·ªáu CV builder:', error);
                hideLoading();
            }
        }

        function selectTemplate(element, templateName) {
            // Remove selected class from all templates
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('selected');
                card.querySelector('input[type="radio"]').checked = false;
            });
            
            // Add selected class to clicked template
            element.classList.add('selected');
            element.querySelector('input[type="radio"]').checked = true;
            
            console.log('Selected template:', templateName);
            updateCVPreview();
        }

        function addSkill() {
            const skillInput = document.getElementById('skillInput');
            const skill = skillInput.value.trim();
            
            if (skill) {
                const skillsContainer = document.getElementById('skillsContainer');
                const skillBadge = document.createElement('span');
                skillBadge.className = 'badge bg-primary skill-badge';
                skillBadge.innerHTML = `${skill} <i class="bi bi-x ms-1" onclick="removeSkill(this)"></i>`;
                skillsContainer.appendChild(skillBadge);
                skillInput.value = '';
                updateCVPreview();
            }
        }

        function removeSkill(element) {
            element.parentElement.remove();
            updateCVPreview();
        }

        function updateCVPreview() {
            const userData = AUTH.getUser();
            const userProfile = JSON.parse(localStorage.getItem(`jobhub_student_profile_${userData.id}`) || '{}');
            const skills = Array.from(document.querySelectorAll('#skillsContainer .badge')).map(badge => 
                badge.textContent.replace('√ó', '').trim()
            );
            
            const cvPreview = document.getElementById('cvPreview');
            cvPreview.innerHTML = `
                <div class="text-center mb-4">
                    <h2 class="fw-bold text-primary">${userProfile.fullName || userData.fullName || 'H·ªå V√Ä T√äN'}</h2>
                    <p class="text-muted mb-2">${document.getElementById('cvTitle').value || 'Ch·ª©c danh'}</p>
                    <div class="d-flex justify-content-center gap-3 flex-wrap">
                        <small><i class="bi bi-telephone me-1"></i>${userProfile.phone || userData.phone || 'S·ªë ƒëi·ªán tho·∫°i'}</small>
                        <small><i class="bi bi-envelope me-1"></i>${userData.email || 'Email'}</small>
                        <small><i class="bi bi-geo-alt me-1"></i>${userProfile.location || 'ƒê·ªãa ch·ªâ'}</small>
                    </div>
                </div>

                <div class="mb-4">
                    <h5 class="fw-bold border-bottom pb-2">M·ª§C TI√äU NGH·ªÄ NGHI·ªÜP</h5>
                    <p class="mb-0">${document.getElementById('careerObjective').value || 'M√¥ t·∫£ m·ª•c ti√™u ngh·ªÅ nghi·ªáp c·ªßa b·∫°n...'}</p>
                </div>

                <div class="mb-4">
                    <h5 class="fw-bold border-bottom pb-2">H·ªåC V·∫§N</h5>
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="fw-semibold mb-0">${userProfile.university || 'T√™n tr∆∞·ªùng ƒë·∫°i h·ªçc'}</h6>
                            <p class="text-muted mb-0">${userProfile.major || 'Chuy√™n ng√†nh'}</p>
                        </div>
                        <div class="text-end">
                            <p class="text-muted mb-0">${userProfile.graduationYear ? `T·ªët nghi·ªáp: ${userProfile.graduationYear}` : 'Th·ªùi gian h·ªçc'}</p>
                            <p class="text-muted mb-0">${userProfile.gpa ? `GPA: ${userProfile.gpa}` : ''}</p>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <h5 class="fw-bold border-bottom pb-2">KINH NGHI·ªÜM L√ÄM VI·ªÜC</h5>
                    <div class="mb-3">
                        <h6 class="fw-semibold mb-0">${userProfile.position || 'V·ªã tr√≠ c√¥ng vi·ªác'}</h6>
                        <p class="text-muted mb-1">${userProfile.company || 'T√™n c√¥ng ty'} | ${userProfile.experience ? `${userProfile.experience} nƒÉm kinh nghi·ªám` : 'Th·ªùi gian l√†m vi·ªác'}</p>
                        <ul class="mb-0">
                            <li>${userProfile.responsibilities || 'M√¥ t·∫£ c√¥ng vi·ªác v√† th√†nh t√≠ch'}</li>
                            <li>K·ªπ nƒÉng v√† c√¥ng ngh·ªá s·ª≠ d·ª•ng</li>
                            <li>K·∫øt qu·∫£ ƒë·∫°t ƒë∆∞·ª£c</li>
                        </ul>
                    </div>
                </div>

                <div class="mb-4">
                    <h5 class="fw-bold border-bottom pb-2">K·ª∏ NƒÇNG CHUY√äN M√îN</h5>
                    <div class="row">
                        <div class="col-md-6">
                            ${skills.length > 0 ? skills.map(skill => `<p class="mb-1">‚Ä¢ ${skill}</p>`).join('') : '<p class="text-muted">Ch∆∞a c√≥ k·ªπ nƒÉng n√†o</p>'}
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <h5 class="fw-bold border-bottom pb-2">D·ª∞ √ÅN C√Å NH√ÇN</h5>
                    <div class="mb-3">
                        <h6 class="fw-semibold mb-0">${userProfile.projectName || 'T√™n d·ª± √°n'}</h6>
                        <p class="text-muted mb-1">${userProfile.projectTech || 'C√¥ng ngh·ªá s·ª≠ d·ª•ng'}</p>
                        <p class="mb-0">${userProfile.projectDescription || 'M√¥ t·∫£ d·ª± √°n v√† vai tr√≤ c·ªßa b·∫°n trong d·ª± √°n.'}</p>
                    </div>
                </div>

                <div>
                    <h5 class="fw-bold border-bottom pb-2">CH·ª®NG CH·ªà & GI·∫¢I TH∆Ø·ªûNG</h5>
                    <div class="mb-3">
                        <h6 class="fw-semibold mb-0">${userProfile.certificate || 'T√™n ch·ª©ng ch·ªâ'}</h6>
                        <p class="text-muted mb-1">${userProfile.certificateOrg || 'T·ªï ch·ª©c c·∫•p'} | ${userProfile.certificateDate || 'Th·ªùi gian'}</p>
                    </div>
                </div>
            `;
        }

        function saveCV() {
            const userData = AUTH.getUser();
            if (!userData) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ l∆∞u CV');
                return;
            }

            const cvData = {
                id: Date.now().toString(),
                title: document.getElementById('cvTitle').value,
                careerObjective: document.getElementById('careerObjective').value,
                skills: Array.from(document.querySelectorAll('#skillsContainer .badge')).map(badge => 
                    badge.textContent.replace('√ó', '').trim()
                ),
                template: document.querySelector('input[name="template"]:checked').parentElement.parentElement.querySelector('.template-preview p').textContent,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            // L∆∞u CV v√†o localStorage
            const userCVs = JSON.parse(localStorage.getItem(`jobhub_cvs_${userData.id}`) || '[]');
            userCVs.push(cvData);
            localStorage.setItem(`jobhub_cvs_${userData.id}`, JSON.stringify(userCVs));

            // C·∫≠p nh·∫≠t profile v·ªõi th√¥ng tin t·ª´ CV
            updateUserProfileWithCV(cvData);

            alert('‚úÖ CV ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!');
            
            // Ki·ªÉm tra n·∫øu c√≥ returnToApply parameter
            const urlParams = new URLSearchParams(window.location.search);
            const returnToApply = urlParams.get('returnToApply');
            
            if (returnToApply) {
                // Quay l·∫°i trang job detail v√† t·ª± ƒë·ªông ·ª©ng tuy·ªÉn
                if (confirm('CV ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng! B·∫°n c√≥ mu·ªën quay l·∫°i ƒë·ªÉ ·ª©ng tuy·ªÉn ngay kh√¥ng?')) {
                    window.location.href = `job-detail.html?id=${returnToApply}&apply=true`;
                }
            }
        }

        function updateUserProfileWithCV(cvData) {
            const userData = AUTH.getUser();
            const userProfile = JSON.parse(localStorage.getItem(`jobhub_student_profile_${userData.id}`) || '{}');
            
            // C·∫≠p nh·∫≠t profile v·ªõi th√¥ng tin t·ª´ CV
            if (cvData.careerObjective && !userProfile.bio) {
                userProfile.bio = cvData.careerObjective;
            }
            
            if (cvData.skills && cvData.skills.length > 0 && !userProfile.skills) {
                userProfile.skills = cvData.skills;
            }
            
            // QUAN TR·ªåNG: ƒê√°nh d·∫•u ƒë√£ c√≥ CV
            userProfile.hasCV = true;
            userProfile.lastCVUpdate = new Date().toISOString();
            
            // T·∫°o resumeUrl n·∫øu ch∆∞a c√≥
            if (!userProfile.resumeUrl) {
                userProfile.resumeUrl = `../cvs/cv_${userData.id}_${Date.now()}.pdf`;
            }
            
            localStorage.setItem(`jobhub_student_profile_${userData.id}`, JSON.stringify(userProfile));
        }

        function saveDraft() {
            const userData = AUTH.getUser();
            if (!userData) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ l∆∞u b·∫£n nh√°p');
                return;
            }

            const draftData = {
                title: document.getElementById('cvTitle').value,
                careerObjective: document.getElementById('careerObjective').value,
                skills: Array.from(document.querySelectorAll('#skillsContainer .badge')).map(badge => 
                    badge.textContent.replace('√ó', '').trim()
                ),
                template: document.querySelector('input[name="template"]:checked').parentElement.parentElement.querySelector('.template-preview p').textContent,
                savedAt: new Date().toISOString()
            };

            // L∆∞u b·∫£n nh√°p
            localStorage.setItem(`jobhub_cv_draft_${userData.id}`, JSON.stringify(draftData));
            alert('üíæ ƒê√£ l∆∞u b·∫£n nh√°p! B·∫°n c√≥ th·ªÉ ti·∫øp t·ª•c ch·ªânh s·ª≠a sau.');
        }

        function previewCV() {
            // T·∫°o preview trong c·ª≠a s·ªï m·ªõi
            const previewWindow = window.open('', '_blank');
            const cvContent = document.getElementById('cvPreview').innerHTML;
            
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Xem tr∆∞·ªõc CV - JobHub</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        body { padding: 20px; background: #f8f9fa; }
                        .cv-preview { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                        @media print {
                            body { background: white; padding: 0; }
                            .cv-preview { box-shadow: none; padding: 0; }
                            .no-print { display: none !important; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                            <h4>Xem tr∆∞·ªõc CV</h4>
                            <button class="btn btn-primary" onclick="window.print()">
                                <i class="bi bi-printer me-2"></i>In CV
                            </button>
                        </div>
                        <div class="cv-preview">
                            ${cvContent}
                        </div>
                    </div>
                </body>
                </html>
            `);
            previewWindow.document.close();
        }

        function downloadCV() {
            const userData = AUTH.getUser();
            if (!userData) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ t·∫£i CV');
                return;
            }

            // T·∫°o n·ªôi dung PDF (ƒë∆°n gi·∫£n)
            const cvContent = document.getElementById('cvPreview').innerHTML;
            
            // Trong th·ª±c t·∫ø, b·∫°n s·∫Ω s·ª≠ d·ª•ng th∆∞ vi·ªán nh∆∞ jsPDF ho·∫∑c html2pdf
            alert('üìÑ T√≠nh nƒÉng t·∫£i xu·ªëng PDF ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn. Hi·ªán t·∫°i b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng "In" t·ª´ tr√¨nh duy·ªát.');
            
            // M·ªü c·ª≠a s·ªï in
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>CV_${userData.fullName}_${new Date().toISOString().split('T')[0]}</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        body { padding: 20px; }
                        @media print {
                            body { padding: 0; }
                        }
                    </style>
                </head>
                <body>
                    ${cvContent}
                    <script>
                        window.onload = function() {
                            window.print();
                        }
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function handleLogout() {
            AUTH.logout();
        }

        function showLoading() {
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('cvBuilderContent').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('cvBuilderContent').style.display = 'block';
        }

        // T·∫£i b·∫£n nh√°p n·∫øu c√≥
        function loadDraft() {
            const userData = AUTH.getUser();
            if (!userData) return;

            const draft = JSON.parse(localStorage.getItem(`jobhub_cv_draft_${userData.id}`) || 'null');
            if (draft) {
                document.getElementById('cvTitle').value = draft.title;
                document.getElementById('careerObjective').value = draft.careerObjective;
                
                const skillsContainer = document.getElementById('skillsContainer');
                skillsContainer.innerHTML = '';
                if (draft.skills && draft.skills.length > 0) {
                    draft.skills.forEach(skill => {
                        const skillBadge = document.createElement('span');
                        skillBadge.className = 'badge bg-primary skill-badge';
                        skillBadge.innerHTML = `${skill} <i class="bi bi-x ms-1" onclick="removeSkill(this)"></i>`;
                        skillsContainer.appendChild(skillBadge);
                    });
                }
                
                // Ch·ªçn template
                const templateCards = document.querySelectorAll('.template-card');
                templateCards.forEach(card => {
                    const templateName = card.querySelector('.template-preview p').textContent;
                    if (templateName === draft.template) {
                        selectTemplate(card, templateName);
                    }
                });
                
                updateCVPreview();
                console.log('ƒê√£ t·∫£i b·∫£n nh√°p CV');
            }
        }

        // Auto-update preview when form changes
        document.getElementById('cvForm').addEventListener('input', updateCVPreview);

        // T·∫£i b·∫£n nh√°p khi trang ƒë∆∞·ª£c t·∫£i
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(loadDraft, 500);
        });
    </script>
</body>
</html>